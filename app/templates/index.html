<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AI Sandbox Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            height: 100vh;
            overflow: hidden;
        }

        #terminal {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="terminal"></div>

    <script>
        // Supabase Logic to protect the route
        const { url, key } = window.SUPABASE_CONFIG || {};
        if (url && key) {
            const supabase = window.supabase.createClient(url, key);
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (!session) {
                    window.location.href = '/login';
                }
            });
        }

        // Terminal Logic
        const term = new Terminal({
            theme: {
                background: '#0f172a',
                foreground: '#e2e8f0',
                cursor: '#38bdf8'
            },
            fontSize: 14,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace'
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/terminal`;
        const ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log('Connected to terminal WebSocket');
            term.write('\r\n\x1b[32mWelcome to AI Sandbox Terminal\x1b[0m\r\n\r\n');
            // Send resize event immediately
            const dims = { cols: term.cols, rows: term.rows };
            ws.send(JSON.stringify({ type: 'resize', ...dims }));
        };

        ws.onmessage = (event) => {
            term.write(event.data);
        };

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
            term.write('\r\n\x1b[31mConnection Error\x1b[0m\r\n');
        };

        ws.onclose = () => {
            term.write('\r\n\x1b[1mConnection Closed\x1b[0m\r\n');
        };

        term.onData(data => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(data);
            }
        });

        window.addEventListener('resize', () => {
            fitAddon.fit();
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows }));
            }
        });
    </script>
</body>

</html>